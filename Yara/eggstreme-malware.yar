rule APT_EggStreme_Framework {
    meta:
        description = "Detects EggStreme fileless malware framework used by Chinese APT groups"
        author = "litemars"
        date = "2025-09-11"
        reference = "Bitdefender EggStreme Analysis"
        severity = "high"
        mitre_attack = "T1055, T1574.002, T1140, T1055.012"
        malware_family = "EggStreme"
        
    strings:
        // EggStremeFuel component strings
        $fuel1 = "mscorsvc.dll" ascii wide
        $fuel2 = "WinMail.exe" ascii wide
        $fuel3 = "myexternalip.com/raw" ascii wide
        $fuel4 = "Cookies.dat" ascii wide
        $fuel5 = "Cookies" ascii  // RC4 key
        
        // EggStremeLoader strings
        $loader1 = "ielowutil.exe.mui" ascii wide
        $loader2 = "en-us" ascii wide
        $loader3 = "google" ascii  // RC4 key
        $loader4 = "Google" ascii  // RC4 key  
        $loader5 = "Microsoft" ascii  // RC4 key
        $loader6 = "microsoft" ascii  // RC4 key
        
        // EggStremeAgent strings
        $agent1 = "EggStremeAgent" ascii wide
        $agent2 = "sealtribute.org" ascii wide
        $agent3 = "Vault.dat" ascii wide
        $agent4 = "splwow64.exe.mui" ascii wide
        $agent5 = "thumbcache.dat" ascii wide
        $agent6 = "usa1!the8*best9#" ascii  // RC4 key for keylogger
        
        // EggStremeWizard strings
        $wizard1 = "xwizards.dll" ascii wide
        $wizard2 = "xwizard.exe" ascii wide
        $wizard3 = "ntuser.dat" ascii wide
        $wizard4 = "ntusers.dat" ascii wide
        $wizard5 = "sinhluc.net" ascii wide
        $wizard6 = "+JBHXU4X*%^Y&(DP" ascii  // AES key
        
        // Stowaway proxy strings
        $proxy1 = "burn.conf" ascii wide
        $proxy2 = "d@rkn3ss" ascii  // Proxy secret
        $proxy3 = "CoStartOutlookExpressW" ascii
        $proxy4 = "CorGetSvc" ascii
        
        // Certificate authority identifier
        $ca_identifier = "51655e8e97fc7265b1aaa4265d94e2f7cae9c913" ascii nocase
        
        // gRPC communication patterns
        $grpc1 = "grpc" ascii nocase
        $grpc2 = "application/grpc" ascii
        
        // Hex patterns for encryption
        $xor_key_dd = { DD DD DD DD }
        $xor_key_fe = { FE FE FE FE }
        
    condition:
        (
            // EggStremeFuel indicators
            (2 of ($fuel*)) or
            // EggStremeLoader indicators  
            (3 of ($loader*)) or
            // EggStremeAgent indicators
            (3 of ($agent*)) or
            // EggStremeWizard indicators
            (2 of ($wizard*)) or
            // Infrastructure indicators
            ($ca_identifier) or
            // Communication patterns
            (1 of ($grpc*) and 1 of ($agent*)) or
            // Proxy component
            (2 of ($proxy*))
        ) and filesize < 10MB
}
