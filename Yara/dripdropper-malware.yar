rule DripDropper_Linux_Malware
{
    meta:
        description = "YARA rule for DripDropper malware exploiting Apache ActiveMQ vulnerabilities"
        author = "litemars"
        date = "2025-08-28"
        version = "1.0"
        hash = "Observed targeting Apache ActiveMQ CVE-2023-46604"
        apt_group = "Unknown (possibly APT41 affiliated)"
        malware_family = "DripDropper"
        mitre_attack = "T1190 (Exploit Public-Facing Application), T1543.002 (Systemd Service)"
        severity = "High"
        target_os = "Linux"
        
    strings:
        // PyInstaller ELF header patterns
        $pyinstaller_magic_1 = { 4D 45 49 00 00 00 00 00 }                  // MEI magic header
        $pyinstaller_magic_2 = { 70 79 69 6D 70 6F 72 74 }                  // pyimport
        $pyinstaller_magic_3 = { 70 79 74 68 6F 6E }                        // python
        
        // Dropbox API integration patterns
        $dropbox_api_1 = "api.dropboxapi.com" ascii wide
        $dropbox_api_2 = "content.dropboxapi.com" ascii wide
        $dropbox_token = "Authorization: Bearer" ascii wide
        $dropbox_upload = "/2/files/upload" ascii wide
        $dropbox_download = "/2/files/download" ascii wide
        
        // SSH configuration modification
        $ssh_config_1 = "/etc/ssh/sshd_config" ascii
        $ssh_permit_root = "PermitRootLogin yes" ascii
        $ssh_password_auth = "PasswordAuthentication yes" ascii
        $ssh_games_user = "games:" ascii
        
        // Cron job persistence mechanisms
        $cron_entry_1 = "/var/spool/cron/crontabs/" ascii
        $cron_entry_2 = "/etc/cron.d/" ascii
        $cron_pattern = "* * * * *" ascii
        
        // Process monitoring and anti-analysis
        $proc_cmdline = "/proc/*/cmdline" ascii
        $proc_status = "/proc/*/status" ascii
        $ps_command = "/bin/ps" ascii
        $netstat_command = "/bin/netstat" ascii
        
        // Password protection mechanism
        $password_check_1 = { 69 66 20 6C 65 6E 28 73 79 73 2E 61 72 67 76 29 }  // if len(sys.argv)
        $password_check_2 = "password" ascii
        $password_check_3 = "Invalid password" ascii
        
        // Apache ActiveMQ exploit artifacts
        $activemq_path_1 = "/opt/activemq" ascii
        $activemq_path_2 = "/apache-activemq" ascii
        $activemq_jar_1 = "activemq-client-" ascii
        $activemq_jar_2 = "activemq-openwire-legacy-" ascii
        $maven_repo = "repo1.maven.org" ascii
        
        // curl download patterns for patching
        $curl_download = { 63 75 72 6C 20 2D 73 20 2D 4C 20 2D 6F }         // curl -s -L -o
        $wget_download = { 77 67 65 74 20 2D 71 20 2D 4F }                   // wget -q -O
        
        // Sliver C2 framework indicators
        $sliver_beacon = "sliver-beacon" ascii
        $sliver_implant = "sliver-implant" ascii
        $sliver_session = "session-id" ascii
        
        // Cloudflare tunnel indicators
        $cloudflared_binary = "cloudflared" ascii
        $cf_tunnel_token = "tunnel-token" ascii
        $cf_tunnel_url = ".trycloudflare.com" ascii
        
        // Base64 encoded payloads
        $base64_pattern_1 = /[A-Za-z0-9+\/]{100,}={0,2}/ ascii
        $base64_pattern_2 = { 65 79 4A }                                      // Base64 "eyJ" (JSON start)
        
    condition:
        uint32(0) == 0x464C457F and                                          // ELF header
        filesize > 1MB and filesize < 50MB and                               // Reasonable size for PyInstaller
        (
            // High confidence: PyInstaller + Dropbox + SSH modification
            (any of ($pyinstaller_magic_*) and any of ($dropbox_*) and any of ($ssh_*)) or
            
            // Medium confidence: ActiveMQ exploitation + patching behavior
            (any of ($activemq_*) and $maven_repo and any of ($curl_download, $wget_download)) or
            
            // Behavioral pattern: C2 frameworks + persistence
            (any of ($sliver_*, $cloudflared_binary, $cf_tunnel_*) and any of ($cron_*)) or
            
            // Password protection + process monitoring
            (2 of ($password_check_*) and any of ($proc_*)) or
            
            // Multiple suspicious indicators
            (4 of ($dropbox_*, $ssh_*, $cron_*, $proc_*, $activemq_*, $sliver_*, $base64_pattern_*))
        ) and
        
        // Additional checks for Linux ELF characteristics
        (
            // Check for executable sections
            for any i in (0..pe.number_of_sections-1): (
                pe.sections[i].characteristics & 0x20000000 != 0 or
                pe.sections[i].name contains "text"
            ) or
            
            // ELF program header checks
            uint16(16) == 0x0002 or uint16(16) == 0x0003                     // ET_EXEC or ET_DYN
        )
}

rule DripDropper_Network_IOCs
{
    meta:
        description = "Network indicators for DripDropper C2 communication"
        author = "litemars"
        date = "2025-08-28"
        version = "1.0"
        
    strings:
        // Dropbox API endpoints used for C2
        $dropbox_endpoint_1 = "https://api.dropboxapi.com/2/files/upload" ascii
        $dropbox_endpoint_2 = "https://content.dropboxapi.com/2/files/download" ascii
        $dropbox_endpoint_3 = "https://api.dropboxapi.com/2/files/list_folder" ascii
        
        // User-Agent strings commonly used
        $user_agent_1 = "Mozilla/5.0 (X11; Linux x86_64)" ascii
        $user_agent_2 = "curl/" ascii
        $user_agent_3 = "python-requests/" ascii
        
        // HTTP headers for Dropbox authentication
        $auth_header = "Authorization: Bearer" ascii
        $content_type = "Content-Type: application/octet-stream" ascii
        $dropbox_api_arg = "Dropbox-API-Arg:" ascii
        
    condition:
        any of them
}