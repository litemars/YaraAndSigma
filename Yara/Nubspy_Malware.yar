rule NubSpy_ScarCruft_Backdoor
{
    meta:
        description = "YARA rule for NubSpy backdoor used by ScarCruft (APT37) group"
        author = "litemars"
        date = "2025-08-28"
        version = "1.0"
        hash = "ScarCruft campaign targeting postal code updates"
        apt_group = "ScarCruft (APT37, Reaper Group)"
        malware_family = "NubSpy"
        mitre_attack = "T1566.001 (Spearphishing Attachment), T1102.002 (Bidirectional Communication)"
        severity = "High"
        
    strings:
        // AutoIt script indicators
        $autoit_magic_1 = { 41 55 21 45 41 }                                 // AU!EA - AutoIt signature
        $autoit_magic_2 = "AutoIt" ascii wide
        $autoit_magic_3 = "#include <" ascii wide
        $autoit_magic_4 = "_WinAPI_" ascii wide
        
        // PubNub API integration
        $pubnub_api_1 = "pubnub.com" ascii wide
        $pubnub_api_2 = "ps.pndsn.com" ascii wide
        $pubnub_channel = "pubnub-channel" ascii wide
        $pubnub_publish = "/v1/publish/" ascii wide
        $pubnub_subscribe = "/v2/subscribe/" ascii wide
        $pubnub_uuid = "uuid=" ascii wide
        
        // PowerShell loader patterns
        $ps_invoke_1 = "Invoke-Expression" ascii wide
        $ps_invoke_2 = "IEX" ascii wide
        $ps_encoded = "EncodedCommand" ascii wide
        $ps_bypass = "ExecutionPolicy Bypass" ascii wide
        $ps_hidden = "WindowStyle Hidden" ascii wide
        
        // C# obfuscated loader characteristics
        $csharp_namespace = "namespace" ascii wide
        $csharp_class = "public class" ascii wide
        $csharp_method = "public static void" ascii wide
        $csharp_assembly = "System.Reflection.Assembly" ascii wide
        $csharp_load = "Assembly.Load" ascii wide
        
        // Registry manipulation for autoruns
        $reg_run_key = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" wide
        $reg_startup = "StartupFolder" wide ascii
        $reg_disable = "REG_SZ /d \"\"" wide ascii
        
        // File download and decryption patterns
        $download_1 = "WebClient" ascii wide
        $download_2 = "DownloadFile" ascii wide
        $download_3 = "DownloadString" ascii wide
        $decrypt_1 = "CryptoStream" ascii wide
        $decrypt_2 = "AesCryptoServiceProvider" ascii wide
        $decrypt_3 = "RijndaelManaged" ascii wide
        
        // Memory execution indicators
        $mem_exec_1 = "VirtualAlloc" ascii wide
        $mem_exec_2 = "WriteProcessMemory" ascii wide
        $mem_exec_3 = "CreateThread" ascii wide
        $mem_exec_4 = "CallWindowProc" ascii wide
        
        // RAR/LNK file exploitation
        $rar_header = { 52 61 72 21 1A 07 00 }                              // RAR header
        $lnk_header = { 4C 00 00 00 01 14 02 00 }                           // LNK header
        $lnk_command = "cmd.exe /c" wide ascii
        
        // Postal code update lure strings (Korean/English)
        $lure_korean_1 = "우편번호" wide                                      // Postal code in Korean
        $lure_korean_2 = "업데이트" wide                                      // Update in Korean
        $lure_english_1 = "postal code" ascii wide nocase
        $lure_english_2 = "update notice" ascii wide nocase
        $lure_english_3 = "zip code" ascii wide nocase
        
        // Network evasion patterns
        $user_agent_1 = "Mozilla/5.0 (Windows NT 10.0" ascii wide
        $user_agent_2 = "User-Agent:" ascii wide
        $http_keep_alive = "Connection: keep-alive" ascii wide
        
        // String obfuscation patterns
        $obfuscation_1 = { 53 74 72 69 6E 67 2E 46 6F 72 6D 61 74 }         // String.Format
        $obfuscation_2 = { 43 68 61 72 2E 43 6F 6E 76 65 72 74 }             // Char.Convert
        $obfuscation_3 = { 42 61 73 65 36 34 }                               // Base64
        
    condition:
        (
            // High confidence: AutoIt + PubNub + Lure content
            (any of ($autoit_magic_*) and any of ($pubnub_*) and any of ($lure_*)) or
            
            // Medium confidence: PowerShell loader + PubNub
            (2 of ($ps_*) and any of ($pubnub_*)) or
            
            // RAR/LNK delivery mechanism
            (($rar_header at 0 or $lnk_header at 0) and any of ($lure_*)) or
            
            // C# loader with registry manipulation
            (2 of ($csharp_*) and any of ($reg_*) and any of ($mem_exec_*)) or
            
            // Multiple behavioral indicators
            (3 of ($pubnub_*, $download_*, $decrypt_*, $reg_*, $obfuscation_*))
        ) and
        
        // File size and format checks
        (
            filesize < 10MB and
            (
                // PE executable
                uint16(0) == 0x5A4D or
                // AutoIt compiled script
                uint32(0) == 0x45413521 or
                // RAR archive
                uint32(0) == 0x21726152 or
                // LNK file
                uint32(0) == 0x0000004C
            )
        )
}

rule ScarCruft_VCD_Ransomware
{
    meta:
        description = "YARA rule for VCD ransomware component of ScarCruft campaign"
        author = "Cybersecurity Analysis Team"  
        date = "2025-08-28"
        version = "1.0"
        apt_group = "ScarCruft (APT37)"
        malware_family = "VCD Ransomware"
        
    strings:
        // VCD ransomware specific indicators
        $vcd_extension = ".VCD" ascii wide
        $vcd_ransom_note_1 = "README_VCD.txt" ascii wide
        $vcd_ransom_note_2 = "복구 안내" wide                                  // Recovery guide in Korean
        
        // RSA + AES encryption combination
        $rsa_key = "RSACryptoServiceProvider" ascii wide
        $aes_cbc = "AES-256-CBC" ascii wide
        $crypto_transform = "CreateEncryptor" ascii wide
        
        // Self-deletion mechanisms
        $self_delete_1 = "cmd.exe /c del" ascii wide
        $self_delete_2 = "sdelete" ascii wide
        $self_delete_3 = "System.IO.File.Delete" ascii wide
        
        // Bilingual ransom note patterns
        $ransom_korean = "파일이 암호화" wide                                   // Files encrypted in Korean
        $ransom_english = "Your files have been encrypted" ascii wide
        
    condition:
        any of ($vcd_*) and 
        (any of ($rsa_*, $aes_*, $crypto_*)) and
        (any of ($self_delete_*) or any of ($ransom_*))
}