rule ZEROLOT_Wiper_Malware
{
    meta:
        description = "YARA rule for ZEROLOT wiper malware used by Sandworm APT group"
        author = "litemars"
        date = "2025-08-28"
        version = "1.0"
        hash = "Various samples observed since February 2025"
        apt_group = "Sandworm (APT44, Telebots, Voodoo Bear)"
        malware_family = "ZEROLOT Wiper"
        mitre_attack = "T1485 (Data Destruction), T1561.002 (Disk Structure Wipe), T1106 (Native API)"
        severity = "Critical"
        
    strings:
        // Stack string construction technique indicators
        $stack_string_1 = { 48 8D 4C 24 ?? 48 C7 44 24 ?? 66 73 75 74 }  // "fsut" construction
        $stack_string_2 = { 48 8D 4C 24 ?? 48 C7 44 24 ?? 69 6C 2E 65 }  // "il.e" construction
        $stack_string_3 = { 48 C7 44 24 ?? 78 65 00 00 }                  // "xe" null terminator
        
        // IOCTL operations for disk manipulation
        $ioctl_disk_delete = { B8 ?? ?? ?? 00 }                            // IOCTL_DISK_DELETE_DRIVE_LAYOUT
        $deviceiocontrol_call = { FF 15 ?? ?? ?? ?? 85 C0 74 }            // DeviceIoControl call pattern
        
        // Physical drive access patterns
        $physicaldrive_0 = "\\\\.\\PhysicalDrive0" wide ascii
        $physicaldrive_generic = "\\\\.\\PhysicalDrive" wide ascii
        
        // Fsutil command construction
        $fsutil_cmd_1 = "fsutil.exe" wide ascii
        $fsutil_cmd_2 = "setzerodataoffset" wide ascii
        $fsutil_zero_param = "file setzerodataoffset" wide ascii
        
        // File enumeration patterns
        $enum_pattern_1 = { 48 8D 4C 24 ?? E8 ?? ?? ?? ?? 48 8D 4C 24 ?? }  // Directory enumeration
        $enum_pattern_2 = { FF 15 ?? ?? ?? ?? 48 8B D8 48 83 FB FF }         // FindFirstFile pattern
        
        // Delay/evasion mechanisms
        $sleep_call = { FF 15 ?? ?? ?? ?? 48 8B 4C 24 }                     // Sleep API call
        $delay_pattern = { B9 ?? ?? ?? ?? FF 15 ?? ?? ?? ?? }               // Delay before execution
        
        // Thread creation for file operations
        $thread_create = { FF 15 ?? ?? ?? ?? 48 8B F8 48 85 C0 }            // CreateThread pattern
        
        // Registry modification indicators
        $reg_modify_1 = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" wide ascii
        $reg_modify_2 = { 48 8D 4C 24 ?? BA ?? ?? ?? 00 }                   // Registry key access
        
    condition:
        uint16(0) == 0x5A4D and                                              // PE header
        filesize < 2MB and                                                   // Reasonable size limit
        (
            // High confidence indicators (stack strings + IOCTL)
            (any of ($stack_string_*) and any of ($ioctl_*)) or
            
            // Medium confidence (fsutil + physical drive access)
            (all of ($fsutil_*) and any of ($physicaldrive_*)) or
            
            // Behavioral pattern match
            (any of ($enum_pattern_*) and $thread_create and any of ($delay_*)) or
            
            // Multiple suspicious patterns
            (3 of ($fsutil_*, $physicaldrive_*, $deviceiocontrol_call, $sleep_call, $thread_create))
        ) and
        
        // Additional context checks
        (
            // PE section characteristics typical of malware
            for any section in pe.sections : (
                section.characteristics & 0x20000000 != 0 or    // IMAGE_SCN_MEM_EXECUTE
                section.characteristics & 0x80000000 != 0        // IMAGE_SCN_MEM_WRITE
            )
        )
}